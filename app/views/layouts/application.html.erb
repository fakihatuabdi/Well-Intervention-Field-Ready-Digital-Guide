<!DOCTYPE html>
<html>
  <head>
    <title>Well Intervention Field-Ready Digital Guide</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>
    <%= favicon_link_tag "logo.png", type: "image/png", sizes: "32x32" %>
    <%= favicon_link_tag "logo.png", rel: "icon", type: "image/png", sizes: "64x64" %>
    <%= favicon_link_tag "logo.png", rel: "apple-touch-icon", sizes: "180x180" %>
    <%= stylesheet_link_tag "tailwind", "data-turbo-track": "reload" %>
    <%= stylesheet_link_tag "application", "data-turbo-track": "reload" %>
    <%= javascript_importmap_tags %>
    <%= hotwire_livereload_tags if Rails.env.development? %>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@heroicons/react@2.0.18/24/outline"></script>
    
    <!-- Firebase SDK (Compat version for easier integration) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <script>
      // Firebase Configuration
      const firebaseConfig = {
        apiKey: "AIzaSyB2Kx60bD58HQ5JqwbqjYaALzEhHQIPbkw",
        authDomain: "wi-field-ready-digital-guide.firebaseapp.com",
        databaseURL: "https://wi-field-ready-digital-guide-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "wi-field-ready-digital-guide",
        storageBucket: "wi-field-ready-digital-guide.firebasestorage.app",
        messagingSenderId: "51623643193",
        appId: "1:51623643193:web:6f244103625708e57a25e8"
      };

      // Initialize Firebase
      if (typeof firebase !== 'undefined' && !firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
        console.log('ðŸ”¥ Firebase initialized successfully!');
      }
      
      // FirebaseViewCounter class - defined globally
      class FirebaseViewCounter {
        constructor() {
          if (typeof firebase !== 'undefined' && firebase.database) {
            this.database = firebase.database();
            this.isInitialized = true;
            console.log('âœ… FirebaseViewCounter: Database connected');
          } else {
            console.warn('âš ï¸ Firebase not initialized');
            this.isInitialized = false;
          }
        }
        
        async incrementArticleView(articleId) {
          if (!this.isInitialized) {
            console.warn('Firebase not initialized, cannot increment view');
            return false;
          }
          
          try {
            const viewRef = this.database.ref(`article_views/${articleId}`);
            await viewRef.transaction((currentValue) => {
              return (currentValue || 0) + 1;
            });
            console.log(`âœ… Article ${articleId} view incremented via Firebase`);
            return true;
          } catch (error) {
            console.error('âŒ Error incrementing view:', error);
            return false;
          }
        }
        
        async getArticleViews(articleId) {
          if (!this.isInitialized) return 0;
          
          try {
            const snapshot = await this.database.ref(`article_views/${articleId}`).once('value');
            return snapshot.val() || 0;
          } catch (error) {
            console.error('Error getting views:', error);
            return 0;
          }
        }
        
        watchArticleViews(articleId, callback) {
          if (!this.isInitialized) return;
          
          const viewRef = this.database.ref(`article_views/${articleId}`);
          viewRef.on('value', (snapshot) => {
            callback(snapshot.val() || 0);
          });
        }
      }
      
      // Create global instance
      window.firebaseViewCounter = new FirebaseViewCounter();
      console.log('ðŸŽ¯ Global firebaseViewCounter initialized');
    </script>
    
    <style>
      * {
        font-family: 'Inter', sans-serif;
      }
      
      /* Simple fade animation - no flash */
      @keyframes gentleFade {
        from { opacity: 0; }
        to { opacity: 1; }
      }
      
      .fade-in {
        opacity: 0;
        animation: gentleFade 0.3s ease-out forwards;
      }
      
      .slide-in {
        opacity: 0;
        animation: gentleFade 0.3s ease-out forwards;
      }
      
      .scale-in {
        opacity: 0;
        animation: gentleFade 0.3s ease-out forwards;
      }
      
      /* Turbo smooth transitions */
      html.turbo-loading {
        cursor: wait;
      }
      
      /* Prevent flash on Turbo navigation */
      body {
        opacity: 1;
        transition: none;
      }
      
      .hover-lift {
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      }
      
      .hover-lift:hover {
        transform: translateY(-8px);
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.12);
      }
      
      .glass-effect {
        background: rgba(255, 255, 255, 0.98);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.3);
      }
      
      .elegant-border {
        border: 1px solid rgba(14, 165, 233, 0.15);
      }
      
      /* Turbo progress bar styling */
      .turbo-progress-bar {
        height: 3px;
        background: linear-gradient(to right, #0ea5e9, #06b6d4);
      }
    </style>
  </head>

  <body class="bg-gradient-to-br from-sky-50 via-white to-cyan-50 min-h-screen">
    <!-- Mobile Menu Button - Always visible on mobile -->
    <button id="mobile-menu-btn" 
            class="fixed top-4 left-4 z-50 lg:hidden bg-white p-3 rounded-lg shadow-lg hover:bg-slate-50 hover:shadow-xl active:scale-95 transition-all duration-200"
            aria-label="Toggle Menu">
      <svg class="w-6 h-6 text-slate-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
      </svg>
    </button>

    <!-- Mobile Overlay -->
    <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 lg:hidden hidden transition-opacity duration-300"></div>

    <!-- Sidebar Navigation -->
    <nav id="sidebar" class="fixed top-0 left-0 h-full w-64 bg-gradient-to-b from-sky-600 via-blue-600 to-cyan-600 text-white shadow-2xl z-40 transform -translate-x-full lg:translate-x-0 transition-transform duration-300 ease-in-out">
      <div class="p-6">
        <div class="mb-8">
          <h1 class="text-xl font-bold mb-1">Well Intervention</h1>
          <p class="text-sm text-sky-100">Field-Ready Digital Guide</p>
        </div>
        
        <ul class="space-y-2">
          <%= link_to home_path, class: "flex items-center gap-3 p-3 rounded-lg hover:bg-sky-700/50 transition-all duration-300 #{current_page?(home_path) ? 'bg-sky-700/70' : ''}" do %>
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
            </svg>
            <span>Home</span>
          <% end %>
          
          <%= link_to handbook_path, class: "flex items-center gap-3 p-3 rounded-lg hover:bg-sky-700/50 transition-all duration-300 #{current_page?(handbook_path) ? 'bg-sky-700/70' : ''}" do %>
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
            </svg>
            <span>Handbook</span>
          <% end %>
          
          <%= link_to search_path, class: "flex items-center gap-3 p-3 rounded-lg hover:bg-sky-700/50 transition-all duration-300 #{current_page?(search_path) ? 'bg-sky-700/70' : ''}" do %>
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
            </svg>
            <span>Search</span>
          <% end %>
          
          <%= link_to calculator_path, class: "flex items-center gap-3 p-3 rounded-lg hover:bg-sky-700/50 transition-all duration-300 #{current_page?(calculator_path) ? 'bg-sky-700/70' : ''}" do %>
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
            </svg>
            <span>Calculator</span>
          <% end %>
          
          <%= link_to chat_bot_path, class: "flex items-center gap-3 p-3 rounded-lg hover:bg-sky-700/50 transition-all duration-300 #{current_page?(chat_bot_path) ? 'bg-sky-700/70' : ''}" do %>
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path>
            </svg>
            <span>AI Chat Bot</span>
          <% end %>
          
          <%= link_to bookmarks_path, class: "flex items-center gap-3 p-3 rounded-lg hover:bg-sky-700/50 transition-all duration-300 #{current_page?(bookmarks_path) ? 'bg-sky-700/70' : ''}" do %>
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"></path>
            </svg>
            <span>Bookmarks</span>
          <% end %>
        </ul>
      </div>
      
      <div class="absolute bottom-0 left-0 right-0 p-6 border-t border-slate-700">
        <p class="text-xs text-sky-100 text-center">
          Upstream Oil & Gas<br>
          Digital Guide v1.0
        </p>
      </div>
    </nav>

    <!-- Main Content -->
    <main class="lg:ml-64 min-h-screen">
      <div class="p-4 lg:p-8">
        <%= yield %>
      </div>
    </main>

    <script>
      // Mobile menu toggle - ensure it works on all pages
      document.addEventListener('DOMContentLoaded', function() {
        const mobileMenuBtn = document.getElementById('mobile-menu-btn');
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('sidebar-overlay');
        
        if (mobileMenuBtn && sidebar && overlay) {
          // Toggle sidebar when clicking menu button
          mobileMenuBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            const isOpen = !sidebar.classList.contains('-translate-x-full');
            
            if (isOpen) {
              closeSidebar();
            } else {
              openSidebar();
            }
          });
          
          // Close sidebar when clicking overlay
          overlay.addEventListener('click', function() {
            closeSidebar();
          });
          
          // Close sidebar when clicking outside on mobile
          document.addEventListener('click', function(e) {
            if (window.innerWidth < 1024) {
              if (!sidebar.contains(e.target) && 
                  !mobileMenuBtn.contains(e.target) &&
                  !sidebar.classList.contains('-translate-x-full')) {
                closeSidebar();
              }
            }
          });
          
          // Close sidebar when clicking any menu link on mobile
          const menuLinks = sidebar.querySelectorAll('a');
          menuLinks.forEach(function(link) {
            link.addEventListener('click', function() {
              if (window.innerWidth < 1024) {
                setTimeout(function() {
                  closeSidebar();
                }, 200);
              }
            });
          });
          
          // Handle window resize
          window.addEventListener('resize', function() {
            if (window.innerWidth >= 1024) {
              sidebar.classList.remove('-translate-x-full');
              overlay.classList.add('hidden');
            } else {
              sidebar.classList.add('-translate-x-full');
              overlay.classList.add('hidden');
            }
          });
          
          // Helper functions
          function openSidebar() {
            sidebar.classList.remove('-translate-x-full');
            overlay.classList.remove('hidden');
            document.body.style.overflow = 'hidden'; // Prevent scrolling
          }
          
          function closeSidebar() {
            sidebar.classList.add('-translate-x-full');
            overlay.classList.add('hidden');
            document.body.style.overflow = ''; // Restore scrolling
          }
        }
      });
      
      // Smooth Turbo navigation
      document.addEventListener('turbo:before-visit', function() {
        document.body.style.opacity = '1';
      });
      
      document.addEventListener('turbo:load', function() {
        document.body.style.opacity = '1';
      });
    </script>
  </body>
</html>
