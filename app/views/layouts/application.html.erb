<!DOCTYPE html>
<html>
  <head>
    <title>Well Intervention Field-Ready Digital Guide</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>
    <%= favicon_link_tag "logo.png", type: "image/png", sizes: "32x32" %>
    <%= favicon_link_tag "logo.png", rel: "icon", type: "image/png", sizes: "64x64" %>
    <%= favicon_link_tag "logo.png", rel: "apple-touch-icon", sizes: "180x180" %>
    <%= stylesheet_link_tag "tailwind", "data-turbo-track": "reload" %>
    <%= stylesheet_link_tag "application", "data-turbo-track": "reload" %>
    <%= javascript_importmap_tags %>
    <%= hotwire_livereload_tags if Rails.env.development? %>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK (Compat version for easier integration) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <script>
      // Firebase Configuration (from ENV)
      <% if ENV['FIREBASE_API_KEY'].present? %>
      const firebaseConfig = {
        apiKey: "<%= ENV['FIREBASE_API_KEY'] %>",
        authDomain: "<%= ENV['FIREBASE_AUTH_DOMAIN'] %>",
        databaseURL: "<%= ENV['FIREBASE_DATABASE_URL'] %>",
        projectId: "<%= ENV['FIREBASE_PROJECT_ID'] %>",
        storageBucket: "<%= ENV['FIREBASE_STORAGE_BUCKET'] %>",
        messagingSenderId: "<%= ENV['FIREBASE_MESSAGING_SENDER_ID'] %>",
        appId: "<%= ENV['FIREBASE_APP_ID'] %>"
      };

      // Initialize Firebase
      if (typeof firebase !== 'undefined' && !firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
        console.log('üî• Firebase initialized successfully!');
      }
      <% else %>
      console.warn('‚ö†Ô∏è Firebase credentials not configured. Set ENV variables for Firebase integration.');
      <% end %>
    </script>
    
    <style>
      * {
        font-family: 'Inter', sans-serif;
      }
      
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(15px); }
        to { opacity: 1; transform: translateY(0); }
      }
      
      @keyframes slideIn {
        from { opacity: 0; transform: translateX(-15px); }
        to { opacity: 1; transform: translateX(0); }
      }
      
      @keyframes scaleIn {
        from { opacity: 0; transform: scale(0.95); }
        to { opacity: 1; transform: scale(1); }
      }
      
      .fade-in {
        animation: fadeIn 0.8s cubic-bezier(0.4, 0, 0.2, 1);
      }
      
      .slide-in {
        animation: slideIn 0.7s cubic-bezier(0.4, 0, 0.2, 1);
      }
      
      .scale-in {
        animation: scaleIn 0.6s cubic-bezier(0.4, 0, 0.2, 1);
      }
      
      .hover-lift {
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      }
      
      .hover-lift:hover {
        transform: translateY(-8px);
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.12);
      }
      
      .glass-effect {
        background: rgba(255, 255, 255, 0.98);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.3);
      }
      
      .elegant-border {
        border: 1px solid rgba(14, 165, 233, 0.15);
      }
    </style>
  </head>

  <body class="bg-gradient-to-br from-sky-50 via-white to-cyan-50 min-h-screen">
    <!-- Flash Messages -->
    <% if notice.present? || alert.present? %>
      <div id="flash-messages" class="fixed top-4 right-4 z-50 max-w-md">
        <% if notice.present? %>
          <div class="bg-green-100 border-l-4 border-green-500 text-green-700 p-4 mb-2 rounded shadow-lg fade-in" role="alert">
            <div class="flex items-center">
              <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
              </svg>
              <p><%= notice %></p>
            </div>
          </div>
        <% end %>
        <% if alert.present? %>
          <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-2 rounded shadow-lg fade-in" role="alert">
            <div class="flex items-center">
              <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
              </svg>
              <p><%= alert %></p>
            </div>
          </div>
        <% end %>
      </div>
      <script>
        // Auto-hide flash messages after 5 seconds
        setTimeout(() => {
          const flashMessages = document.getElementById('flash-messages');
          if (flashMessages) {
            flashMessages.style.opacity = '0';
            flashMessages.style.transition = 'opacity 0.5s';
            setTimeout(() => flashMessages.remove(), 500);
          }
        }, 5000);
      </script>
    <% end %>
    
    <!-- Mobile Menu Button - Always visible on mobile -->
    <button id="mobile-menu-btn" 
            class="fixed top-4 left-4 z-50 lg:hidden bg-white p-3 rounded-lg shadow-lg hover:bg-slate-50 hover:shadow-xl active:scale-95 transition-all duration-200"
            aria-label="Toggle Menu">
      <svg class="w-6 h-6 text-slate-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
      </svg>
    </button>

    <!-- Mobile Overlay -->
    <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 lg:hidden hidden transition-opacity duration-300"></div>

    <!-- Sidebar Navigation -->
    <nav id="sidebar" class="fixed top-0 left-0 h-full w-64 bg-gradient-to-b from-sky-600 via-blue-600 to-cyan-600 text-white shadow-2xl z-40 transform -translate-x-full lg:translate-x-0 transition-transform duration-300 ease-in-out">
      <div class="p-6">
        <div class="mb-8">
          <h1 class="text-xl font-bold mb-1">Well Intervention</h1>
          <p class="text-sm text-sky-100">Field-Ready Digital Guide</p>
        </div>
        
        <ul class="space-y-2">
          <%= link_to home_path, class: "flex items-center gap-3 p-3 rounded-lg hover:bg-sky-700/50 transition-all duration-300 #{current_page?(home_path) ? 'bg-sky-700/70' : ''}" do %>
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
            </svg>
            <span>Home</span>
          <% end %>
          
          <%= link_to handbook_path, class: "flex items-center gap-3 p-3 rounded-lg hover:bg-sky-700/50 transition-all duration-300 #{current_page?(handbook_path) ? 'bg-sky-700/70' : ''}" do %>
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
            </svg>
            <span>Handbook</span>
          <% end %>
          
          <%= link_to search_path, class: "flex items-center gap-3 p-3 rounded-lg hover:bg-sky-700/50 transition-all duration-300 #{current_page?(search_path) ? 'bg-sky-700/70' : ''}" do %>
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
            </svg>
            <span>Search</span>
          <% end %>
          
          <%= link_to calculator_path, class: "flex items-center gap-3 p-3 rounded-lg hover:bg-sky-700/50 transition-all duration-300 #{current_page?(calculator_path) ? 'bg-sky-700/70' : ''}" do %>
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
            </svg>
            <span>Calculator</span>
          <% end %>
          
          <%= link_to chat_bot_path, class: "flex items-center gap-3 p-3 rounded-lg hover:bg-sky-700/50 transition-all duration-300 #{current_page?(chat_bot_path) ? 'bg-sky-700/70' : ''}" do %>
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path>
            </svg>
            <span>AI Chat Bot</span>
          <% end %>
          
          <%= link_to bookmarks_path, class: "flex items-center gap-3 p-3 rounded-lg hover:bg-sky-700/50 transition-all duration-300 #{current_page?(bookmarks_path) ? 'bg-sky-700/70' : ''}" do %>
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"></path>
            </svg>
            <span>Bookmarks</span>
          <% end %>
        </ul>
      </div>
      
      <div class="absolute bottom-0 left-0 right-0 p-6 border-t border-slate-700">
        <p class="text-xs text-sky-100 text-center">
          Upstream Oil & Gas<br>
          Digital Guide v1.0
        </p>
      </div>
    </nav>

    <!-- Main Content -->
    <main class="lg:ml-64 min-h-screen">
      <div class="p-4 lg:p-8">
        <%= yield %>
      </div>
    </main>

    <script>
      // Mobile menu with Turbo support - prevent redeclaration
      (function() {
        const stateKey = 'mobile_menu_state';
        
        function cleanup() {
          const state = window[stateKey];
          if (state) {
            state.eventListeners?.forEach(({ element, event, handler }) => {
              if (element) element.removeEventListener(event, handler);
            });
            delete window[stateKey];
          }
        }
        
        function initialize() {
          cleanup();
          
          const mobileMenuBtn = document.getElementById('mobile-menu-btn');
          const sidebar = document.getElementById('sidebar');
          const overlay = document.getElementById('sidebar-overlay');
          
          if (!mobileMenuBtn || !sidebar || !overlay) return;
          
          window[stateKey] = {
            eventListeners: []
          };
          
          const state = window[stateKey];
          
          // Reset sidebar state on page load/restore
          if (window.innerWidth < 1024) {
            sidebar.classList.add('-translate-x-full');
            overlay.classList.add('hidden');
          }
          document.body.style.overflow = '';
          
          // Helper functions
          function openSidebar() {
            sidebar.classList.remove('-translate-x-full');
            overlay.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
          }
          
          function closeSidebar() {
            sidebar.classList.add('-translate-x-full');
            overlay.classList.add('hidden');
            document.body.style.overflow = '';
          }
          
          // Toggle sidebar when clicking menu button
          const menuBtnHandler = function(e) {
            e.stopPropagation();
            const isOpen = !sidebar.classList.contains('-translate-x-full');
            isOpen ? closeSidebar() : openSidebar();
          };
          mobileMenuBtn.addEventListener('click', menuBtnHandler);
          state.eventListeners.push({ element: mobileMenuBtn, event: 'click', handler: menuBtnHandler });
          
          // Close sidebar when clicking overlay
          const overlayHandler = function() {
            closeSidebar();
          };
          overlay.addEventListener('click', overlayHandler);
          state.eventListeners.push({ element: overlay, event: 'click', handler: overlayHandler });
        
          // Close sidebar when clicking outside on mobile
          const documentClickHandler = function(e) {
            if (window.innerWidth < 1024) {
              if (!sidebar.contains(e.target) && 
                  !mobileMenuBtn.contains(e.target) &&
                  !sidebar.classList.contains('-translate-x-full')) {
                closeSidebar();
              }
            }
          };
          document.addEventListener('click', documentClickHandler);
          state.eventListeners.push({ element: document, event: 'click', handler: documentClickHandler });
          
          // Close sidebar when clicking any menu link on mobile
          const menuLinks = sidebar.querySelectorAll('a');
          menuLinks.forEach(function(link) {
            const linkHandler = function() {
              if (window.innerWidth < 1024) {
                setTimeout(closeSidebar, 200);
              }
            };
            link.addEventListener('click', linkHandler);
            state.eventListeners.push({ element: link, event: 'click', handler: linkHandler });
          });
          
          // Handle window resize
          const resizeHandler = function() {
            if (window.innerWidth >= 1024) {
              sidebar.classList.remove('-translate-x-full');
              overlay.classList.add('hidden');
              document.body.style.overflow = '';
            } else {
              sidebar.classList.add('-translate-x-full');
              overlay.classList.add('hidden');
            }
          };
          window.addEventListener('resize', resizeHandler);
          state.eventListeners.push({ element: window, event: 'resize', handler: resizeHandler });
        }
        
        // Initialize on Turbo load (works for initial load AND back/forward)
        document.addEventListener('turbo:load', initialize, { once: true });
        initialize();
        
        // Cleanup before Turbo caches the page
        document.addEventListener('turbo:before-cache', function() {
          cleanup();
          
          // Ensure sidebar is closed before caching
          const sidebar = document.getElementById('sidebar');
          const overlay = document.getElementById('sidebar-overlay');
          if (sidebar && window.innerWidth < 1024) {
            sidebar.classList.add('-translate-x-full');
          }
          if (overlay) {
            overlay.classList.add('hidden');
          }
          document.body.style.overflow = '';
        }, { once: true });
      })();
    </script>
  </body>
</html>
